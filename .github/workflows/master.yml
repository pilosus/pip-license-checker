name: master

on:
  push:
    branches: [ "main" ]

env:
  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
  CLOJARS_USERNAME: ${{ secrets.CLOJARS_USERNAME }}
  CLOJARS_PASSWORD: ${{ secrets.CLOJARS_PASSWORD }}

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout the code
      uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c  # v3, master on 29-12-2022
      with:
        fetch-depth: 0
    - name: Install dependencies
      run: lein deps
    - name: Code formatting check
      run: lein cljfmt check
    - name: Code linting
      uses: DeLaGuardo/clojure-lint-action@2d6013175031096ae07bc9b90a07173029ad7dc9  # master 02-11-2021, uses cljkondo/clj-kondo:latest
      with:
        clj-kondo-args: --lint src test
        github_token: ${{ secrets.GITHUB_TOKEN }}
    - name: Run tests
      run: lein cloverage --codecov
    - name: Update code coverage report
      run: |
        curl https://keybase.io/codecovsecurity/pgp_keys.asc | gpg --no-default-keyring --keyring trustedkeys.gpg --import
        curl -Os https://uploader.codecov.io/latest/linux/codecov
        curl -Os https://uploader.codecov.io/latest/linux/codecov.SHA256SUM
        curl -Os https://uploader.codecov.io/latest/linux/codecov.SHA256SUM.sig
        gpgv codecov.SHA256SUM.sig codecov.SHA256SUM
        shasum -a 256 -c codecov.SHA256SUM
        chmod +x codecov
        ./codecov -t ${CODECOV_TOKEN} -f target/coverage/codecov.json
    - name: Publish artifact
      run: lein deploy releases

  license_check:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout the code
      uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c  # v3, master on 29-12-2022
      with:
        fetch-depth: 0
    - name: Get deps licenses
      run: |
        lein licenses :csv > licenses.csv
    - name: Check licenses
      id: license_check_report
      uses: pilosus/action-pip-license-checker@41a74340807e2809f38004ca7da04766da629036  # v0.8.0-rc1, master on 30-12-2022
      with:
        external: 'licenses.csv'
        external-format: 'csv'
        external-options: '{:skip-header false :package-column-index 0 :license-column-index 2}'
        with-totals: true
        table-headers: true
    - name: Print report
      if: ${{ always() }}
      run: echo "${{ steps.license_check_report.outputs.report }}"
